{% extends 'base.html' %}
{% block title %}Dashboard â€” FinanceTracker{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-0">
        Good {% now "G" as hour %}{% if hour < 12 %}morning{% elif hour < 17 %}afternoon{% else %}evening{% endif %},
        {{ request.user.first_name|default:request.user.username }}! ðŸ‘‹
      </h4>
      <p class="text-muted mb-0 small">Here's your financial overview</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'expense_create' %}" class="btn btn-danger btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Add Expense
      </a>
      <a href="{% url 'income_create' %}" class="btn btn-success btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Add Income
      </a>
    </div>
  </div>

  <!-- Date Filter -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">From Date</label>
          {{ filter_form.date_from }}
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">To Date</label>
          {{ filter_form.date_to }}
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-sm w-100">
            <i class="bi bi-funnel me-1"></i>Filter
          </button>
        </div>
        {% if date_from or date_to %}
        <div class="col-md-2">
          <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-x-circle me-1"></i>Clear
          </a>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="summary-card income-card">
        <div class="summary-icon">
          <i class="bi bi-arrow-up-circle-fill"></i>
        </div>
        <div class="summary-info">
          <span class="summary-label">Total Income</span>
          <span class="summary-value">{{ user_currency }}{{ total_income|floatformat:2 }}</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-card expense-card">
        <div class="summary-icon">
          <i class="bi bi-arrow-down-circle-fill"></i>
        </div>
        <div class="summary-info">
          <span class="summary-label">Total Expenses</span>
          <span class="summary-value">{{ user_currency }}{{ total_expenses|floatformat:2 }}</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="summary-card {% if balance >= 0 %}balance-card{% else %}balance-negative-card{% endif %}">
        <div class="summary-icon">
          <i class="bi bi-wallet2"></i>
        </div>
        <div class="summary-info">
          <span class="summary-label">Balance</span>
          <span class="summary-value">
            {% if balance < 0 %}-{% endif %}{{ user_currency }}{{ balance|floatformat:2 }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 pt-3">
          <h6 class="fw-bold mb-0"><i class="bi bi-bar-chart me-2 text-primary"></i>Monthly Overview</h6>
        </div>
        <div class="card-body">
          <canvas id="barChart" height="100"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 pt-3">
          <h6 class="fw-bold mb-0"><i class="bi bi-pie-chart me-2 text-primary"></i>By Category</h6>
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
          {% if pie_data != "[]" %}
            <canvas id="pieChart" height="220"></canvas>
          {% else %}
            <div class="text-center text-muted py-5">
              <i class="bi bi-pie-chart display-4 d-block mb-2 opacity-25"></i>
              <p class="mb-0">No expense data yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 pt-3 d-flex justify-content-between">
          <h6 class="fw-bold mb-0"><i class="bi bi-arrow-down-circle me-2 text-danger"></i>Recent Expenses</h6>
          <a href="{% url 'expense_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body p-0">
          {% if recent_expenses %}
          <div class="list-group list-group-flush">
            {% for expense in recent_expenses %}
            <div class="list-group-item border-0 px-3 py-2">
              <div class="d-flex align-items-center">
                <div class="tx-icon me-3" style="background: {{ expense.category.color|default:'#6c757d' }}22; color: {{ expense.category.color|default:'#6c757d' }};">
                  <i class="bi {{ expense.category.icon|default:'bi-tag' }}"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-semibold small">{{ expense.title }}</div>
                  <div class="text-muted" style="font-size:0.75rem;">
                    {{ expense.category.name|default:"Uncategorized" }} Â· {{ expense.date|date:"M d" }}
                  </div>
                </div>
                <span class="text-danger fw-bold">-{{ user_currency }}{{ expense.amount|floatformat:2 }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox display-6 d-block mb-2 opacity-25"></i>
            <p class="small mb-2">No expenses yet</p>
            <a href="{% url 'expense_create' %}" class="btn btn-sm btn-primary">Add your first</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 pt-3 d-flex justify-content-between">
          <h6 class="fw-bold mb-0"><i class="bi bi-arrow-up-circle me-2 text-success"></i>Recent Income</h6>
          <a href="{% url 'income_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body p-0">
          {% if recent_income %}
          <div class="list-group list-group-flush">
            {% for income in recent_income %}
            <div class="list-group-item border-0 px-3 py-2">
              <div class="d-flex align-items-center">
                <div class="tx-icon me-3" style="background: {{ income.category.color|default:'#27ae60' }}22; color: {{ income.category.color|default:'#27ae60' }};">
                  <i class="bi {{ income.category.icon|default:'bi-cash' }}"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-semibold small">{{ income.title }}</div>
                  <div class="text-muted" style="font-size:0.75rem;">
                    {{ income.category.name|default:"Other" }} Â· {{ income.date|date:"M d" }}
                  </div>
                </div>
                <span class="text-success fw-bold">+{{ user_currency }}{{ income.amount|floatformat:2 }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox display-6 d-block mb-2 opacity-25"></i>
            <p class="small mb-2">No income yet</p>
            <a href="{% url 'income_create' %}" class="btn btn-sm btn-success">Add income</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const chartLabels = {{ chart_labels|safe }};
const expenseData = {{ chart_expense_data|safe }};
const incomeData = {{ chart_income_data|safe }};
const pieLabels = {{ pie_labels|safe }};
const pieData = {{ pie_data|safe }};
const pieColors = {{ pie_colors|safe }};
const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
const gridColor = isDark ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.05)';
const textColor = isDark ? '#adb5bd' : '#6c757d';

// Bar Chart
const barCtx = document.getElementById('barChart');
if (barCtx) {
  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: chartLabels.length ? chartLabels : ['No data'],
      datasets: [
        {
          label: 'Income',
          data: incomeData.length ? incomeData : [0],
          backgroundColor: 'rgba(40, 167, 69, 0.75)',
          borderRadius: 6,
        },
        {
          label: 'Expenses',
          data: expenseData.length ? expenseData : [0],
          backgroundColor: 'rgba(220, 53, 69, 0.75)',
          borderRadius: 6,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: textColor } } },
      scales: {
        x: { grid: { color: gridColor }, ticks: { color: textColor } },
        y: { grid: { color: gridColor }, ticks: { color: textColor } }
      }
    }
  });
}

// Pie Chart
const pieCtx = document.getElementById('pieChart');
if (pieCtx && pieData.length > 0) {
  new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieData,
        backgroundColor: pieColors.length ? pieColors : ['#667eea','#f093fb','#4facfe','#43e97b'],
        borderWidth: 2,
        borderColor: isDark ? '#1a1d23' : '#fff',
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: textColor, padding: 10, font: { size: 11 } }
        }
      }
    }
  });
}
</script>
{% endblock %}
